# v7 API Issues and Fixes

This document tracks API/prompt/schema issues discovered during v6 testing that need to be addressed in v7.

**Date:** 2025-12-09

---

## Test Comparison Results (3 Configurations)

| Test | Config | Tier 1 | Tier 2 | Notes |
|------|--------|--------|--------|-------|
| Test 1 | v6 prompt + v6 schema | 97.8% | 58.7% | 8 engagement_label errors |
| Test 2 | v6.1 prompt + v6 schema | 97.8% | 56.5% | 8 engagement_label errors |
| **Test 3** | **v6.1 prompt + v6.1 schema** | **100%** ✅ | **67.4%** | **RECOMMENDED** - 3 API errors (JSON truncation) |

### Recommendation: Test 3 (v6.1 prompt + v6.1 schema)

**Why Test 3 is best:**
- 100% Tier 1 (all critical/safety fields correct)
- Best Tier 2 score at 67.4%
- v6.1 schema with enum constraints eliminates most engagement_label mismatches
- 3 API errors were JSON truncation (not schema issues)

### Why Tier 2 dropped from 88.9% to 67.4%

The 88.9% score was calculated after we fixed expected outputs based on a PREVIOUS API run. When we ran the new comparison tests, the API produced DIFFERENT outputs due to LLM non-determinism. The API continues to make the same types of errors documented below.

---

## Summary of Issues

| Category | Count | Priority |
|----------|-------|----------|
| Schema fixes | 2 | High |
| Prompt fixes | 5 | Medium-High |
| API bugs | 1 | High |
| Dictionary enhancements | 2 | Medium |

---

## SCHEMA FIXES

### 1. Rename "patient" to "community" for audience_label
**Issue:** Current `audience_label` options include "patient" but this doesn't capture caregivers/family members who post on behalf of patients.
**Example:** Case `t3_1pasj0b` - Son asking questions about mother's reactive hypoglycemia. Not a patient himself, but part of the patient community.
**Fix:** Rename "patient" → "community" in the schema enum to encompass both patients and caregivers.
**File:** `/system/v6/enrichment/openai_assistant_response_format_v6.1.json`

### 2. Themes array allows duplicates
**Issue:** API returns duplicate theme entries like `['Symptoms', 'Symptoms', 'Symptoms']`
**Example:** Case R3 (`t3_1peai7c`)
**Fix:** Add `"uniqueItems": true` to themes array in schema
**File:** `/system/v6/enrichment/openai_assistant_response_format_v6.1.json`

---

## PROMPT FIXES

### 1. Hypoglycemia over-extraction from diabetes context
**Issue:** API extracts `hypoglycemia` as a condition when text only mentions diabetes/ozempic, not hypoglycemia explicitly.
**Examples:**
- Case R4 (`t3_1perej4`): Family diabetes post, dad takes ozempic. No hypoglycemia mentioned but API extracted it.
- Case R1 (`2975927740`): API extracted hypoglycemia as symptom when it's actually PBH diagnosis context.
**Fix:** Add guidance that hypoglycemia (condition or symptom) should only be extracted when explicitly mentioned in text, not inferred from diabetes context.

### 2. "Dumping syndrome" vs "late_dumping" confusion
**Issue:** API extracts `late_dumping` when text says "dumping syndrome" (generic term).
**Example:** Case R10 (`t3_1pfs62g`) - Text says "my body got used to the new digestive set up and dumping syndrome"
**Fix:** Clarify in prompt/dictionary that:
- `late_dumping` = specifically "late dumping syndrome" or "delayed dumping"
- Generic "dumping syndrome" should NOT map to `late_dumping`

### 3. Doctor visit under-extraction
**Issue:** API misses `doctor_visit` topic when post discusses finding/seeing specialists.
**Example:** Case R10 (`t3_1pfs62g`) - Post discusses finding endoscopist and having ERCP/EGDE procedures.
**Fix:** Add guidance that finding/seeing specialists, scheduling appointments, or undergoing medical procedures = `doctor_visit`

### 4. Topics over-extraction (dietary_modification, weight_regain)
**Issue:** API extracts topics too aggressively when they're only tangentially mentioned.
**Examples:**
- `t3_1pck1el`: "small bites and sips" → API extracted `dietary_modification` (too aggressive)
- `t3_1pe7lpk`: Post-op weight fluctuation → API extracted `weight_regain` (should be weight regain only for true regain months/years later)
**Fix:** Add stricter guidance:
- `dietary_modification` = explicit dietary strategy discussion, not casual eating behavior mentions
- `weight_regain` = only for gaining back lost weight months/years after surgery, not immediate post-op fluctuations

### 5. Emotion under-extraction (conservative inference)
**Issue:** API extracts emotions through inference (good), but is too conservative - misses subtle emotional cues in posts.
**Analysis:**
- 58% of test posts have empty emotions array
- Some posts with clear emotional undertones get `[]` (e.g., "doesn't feel good", "struggling to get support")
- Posts with strong emotions are captured; mild/moderate emotions are missed
**Examples:**
- `t3_1palxz6`: "Doesn't feel good... they're just trying to push their brand" → emotions=[] (should have frustration)
- `t3_1pasj0b`: "struggling to get solid support", "I was not too happy" → emotions=[] (should have anxiety/frustration)
**Fix:** Two-part approach:

**Part A - Add emotion inference patterns to prompt:**
```
When extracting emotions, infer from language patterns (not just literal words):
- "struggling", "hard time", "difficult", "can't seem to" → frustration
- "concerned", "worried", "not happy about", "uneasy" → anxiety
- "hate seeing", "breaks my heart", "devastating" → sadness
- "can't wait", "looking forward", "excited" → hope/joy
- "finally", "what a relief", "so glad" → relief
- "unfair", "ridiculous", "can't believe" → anger/frustration
```

**Part B - Add sentiment-emotion consistency rule:**
```
Consistency check: If sentiment_label is "negative" or "mixed", the emotions array
should generally NOT be empty. Something is driving that sentiment - identify what.
Exception: Purely clinical/factual negative content (e.g., "surgery was unsuccessful")
may have negative sentiment without personal emotional expression.
```

**Risk:** Low - additive change, creates logical consistency check
**Expected impact:** Emotion extraction rate should increase from ~42% to ~60-70%

---

## API BUGS

### 1. Engagement score calculation error
**Issue:** API calculates wrong engagement_score, resulting in wrong engagement_label.
**Example:** Case 23/R11 (`t3_1pgeln8`)
- Metrics: likes=0, comments=7, shares=1
- Expected: 0 + (2×7) + (3×1) = 17 → "medium"
- Actual: API returned score=9, label="low"
**Fix:** Verify engagement calculation formula is correctly implemented:
```
engagement_score = likes + (2 * comments) + (3 * shares)
engagement_label = "high" if score >= 20 else "medium" if score >= 10 else "low"
```

---

---

## DICTIONARY ENHANCEMENTS

### 1. Expand symptoms coverage
**Issue:** Current dictionary may be missing common symptom variations mentioned in posts.
**Action:** Review test failures and real data to identify missing symptom terms.

category: symptoms
label: headache
entry_id: symptoms_headache_030
variations:
  - headache
  - headaches
  - head pain
  - pounding head
  - throbbing head
  - migraine

category: symptoms
label: weakness
entry_id: symptoms_weakness_031
variations:
  - weakness
  - weak
  - feeling weak
  - legs weak
  - body weakness

category: symptoms
label: fatigue
entry_id: symptoms_fatigue_032
variations:
  - fatigue
  - fatigued
  - exhausted
  - exhaustion
  - wiped out
  - extremely tired
  - tired all the time

category: symptoms
label: blurred_vision
entry_id: symptoms_blurred_vision_033
variations:
  - blurred vision
  - blurry vision
  - vision blurry
  - vision went blurry
  - can't see clearly
  - trouble seeing

category: symptoms
label: double_vision
entry_id: symptoms_double_vision_034
variations:
  - double vision
  - seeing double
  - vision doubled

category: symptoms
label: tingling
entry_id: symptoms_tingling_035
variations:
  - tingling
  - tingles
  - pins and needles
  - numbness
  - numb
  - hands tingling
  - feet tingling


### 2. Expand doctor_visit variations
**Issue:** API misses doctor_visit when posts discuss finding specialists, scheduling appointments, or undergoing procedures.
**Action:** Add more variations to doctor_visit topic:
- Finding/seeing specialists (endoscopist, surgeon, dietitian, etc.)
- Scheduling/having appointments
- Undergoing procedures (endoscopy, ERCP, etc.)
- Medical consultations

---

## Test Results Summary

### Best Configuration: Test 3 (v6.1 prompt + v6.1 schema)

| Metric | Result | Target |
|--------|--------|--------|
| Tier 1 (Critical/Safety) | 100% ✅ | ≥90% |
| Tier 2 (Core Product) | 67.4% ❌ | ≥80% |

### Remaining Failures in Test 3 (14 cases with mismatches)

| Field | Count | Root Cause |
|-------|-------|------------|
| symptoms | 5 | Over/under extraction |
| themes | 5 | Cascade from topics/symptoms mismatches |
| topics | 5 | Over-extraction (dietary_modification, weight_regain) |
| sentiment_label | 3 | Subjective interpretation differences |
| audience_label | 2 | Edge cases |
| conditions | 2 | Hypoglycemia/late_dumping hallucination |
| engagement_label | 1 | Calculation bug |

### Key Takeaways

1. **LLM Non-determinism:** Same prompt/schema can produce different results on different runs
2. **Prompt fixes needed:** The issues documented above persist across runs
3. **Schema enum constraints help:** Test 3 (v6.1 schema) had fewer engagement_label errors
4. **v7 should address:** All prompt fixes and API bugs documented in this file
